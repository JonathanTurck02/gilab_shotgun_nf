// ──────────────────────────────────────────────
//  bioBakery Nextflow Pipeline – Configuration
// ──────────────────────────────────────────────

params {
    input        = "/scratch/user/${System.getenv('USER')}/data"
    pattern      = "*_R{1,2}*.fastq.gz"
    output       = "/scratch/user/${System.getenv('USER')}/results"
    kneaddata_db = "/scratch/user/${System.getenv('USER')}/03_resources/dog_host/dog"
}

// ── Process defaults & per-process resources ──
process {
    executor = 'slurm'
    clusterOptions = '--nodes=1 --ntasks=1'
    queue    = { task.time <= 2.h ? 'short' : task.time <= 24.h ? 'medium' : 'long' }

    // Default resources
    cpus   = 1
    memory = '4 GB'
    time   = '2h'

    // Use HPC modules for all software
    beforeScript = 'module purge'

    withName: 'FASTP' {
        cpus   = 4
        memory = '8 GB'
        time   = '1h'
        module = 'GCC/13.2.0:fastp/0.23.4'
    }

    withName: 'KNEADDATA' {
        cpus   = 8
        memory = '32 GB'
        time   = '4h'
        module = 'GCC/11.3.0:OpenMPI/4.1.4:kneaddata/0.12.2'
    }

    withName: 'CAT' {
        cpus   = 1
        memory = '4 GB'
        time   = '30m'
    }

    withName: 'METAPHLAN' {
        cpus   = 8
        memory = '32 GB'
        time   = '3h'
        module = 'GCC/12.3.0:OpenMPI/4.1.5:MetaPhlAn/4.2.4'
    }
}

executor {
    queueSize = 20
    submitRateLimit = '20 sec'
    pollInterval = '30 sec'
    exitReadTimeout = '5 min'
}

// ── Execution profiles ──
profiles {
    standard {
        process.executor = 'local'
    }

    slurm {
        process.executor = 'slurm'
    }
}

// ── Disk management ──
// Remove intermediate work files once all downstream consumers finish.
cleanup = true

// Limit concurrent SLURM jobs so intermediate files don't pile up
executor {
    name      = 'slurm'
    queueSize = 30
}

// ── Nextflow environment ──
env {
    NXF_ASSETS = "$SCRATCH/.nextflow"
    NXF_WORK   = "/scratch/user/${System.getenv('USER')}/.nextflow_work"
}

// ── Timeline / report ──
timeline {
    enabled = true
    file    = "${params.output}/pipeline_info/timeline.html"
}

report {
    enabled = true
    file    = "${params.output}/pipeline_info/report.html"
}
